---
layout: post
author: Yan 
toc: true
image: assets/images/miscellaneous/githooks-logo.png
title: Automatic deployment of githooks
tags:
categories: git
top-first: false
top-twice: false
first-level-classification: miscellaneous
twice-level-classification:
permalink: /:year/:month/:day/:title:output_ext
---

Githooks implement automatic deployment to the server

## Brief description


travis can only deploy open source projects, and there are problems during the travis deployment process, which is extremely difficult to debug, and there are security risks to the account and server, and using travis, the git source repository cannot be placed on the server.
If it is deployed on a server, whether it is an open source or closed source project, githooks is a simple, easy to use and safe method

1. Set up `githooks` on the server
2. Local push code triggers `hooks` to complete automatic deployment

Use `traivs` for automatic deployment can refer to --> [`travis` to achieve automatic deployment] ({{ site.baseurl }}/2020/06/08/jekyll-travis.html)

## Environmental preparation

Mainly about git settings on the server

### server


The server can use Alibaba Cloud or Tencent Cloud. The configuration can basically go to the minimum configuration. Most of the time, only one nginx is run. The system selects ubuntu or centos. The following uses Alibaba Cloud of ubuntu18.04 as an example

Update the system after logging into the server

```shell
root# apt update 
root# apt upgrade
```


In order to avoid security risks, an ordinary user with sudo privileges should be established to deploy the blog. Follow the method in [Linux New User] ({{ site.baseurl }}/2020/06/05/add-user.html) .
After that, all operations are switched to ordinary users.

### git

#### Install git

The git tool needs to be installed on the server

```shell
$ sudo apt install git 
```

### nginx

For the installation and setting of `ngix` on the server, please refer to [Nginx Installation Configuration] ({{ site.baseurl }}/2020/06/06/nginx.html)

After configuring the environment, the `root` path does not need to be configured first

## The deployment process

Mainly generate `hooks repositories`, compile static webpages after triggering, `nginx` deployment

### Generate `hooks repositories`

This step is completed on the server

```shell
$ cd ${workspace}
$ git init --bare ${hooks-name}.git
```

When adding `--bare` to `git init`, it is declared that the generated warehouse is an empty `bare` warehouse. This warehouse is the `githooks` warehouse we want to use.

```shell
$ cd ${workspace}/${hooks-name}.git/hooks
```

This is where the trigger script is stored. Create a new trigger script `post-receive` in this directory. Set the execution permission `chmod +x post-receive`

Enter the directory where you want to place the source code

```shell
$ cd ${sourcespace}
```

Clone the `githooks` repository

```shell
$ git clone ${workspace}/${hooks-name}.git 
```

The `${sourcespace}` directory will have an additional `${hooks-name}` folder. In the future, every time the push code triggers `hooks`, `hooks` will synchronize the code to this folder

Go back to the `githooks` directory and set the trigger script, the content is as follows

```shell
#!/bin/bash
unset GIT_DIR
NowPath=`pwd`
DeployPath="${sourcespace}/${hooks-name}"
cd $DeployPath
git config user.email ${email}
git config user.name ${user}
git add . -A && git stash
git pull origin master
bash ${script-name}.sh
```

Among them, `${script-name}.sh` is the script that triggers `hooks` and executes after the code is synchronized.You can add any code you want to execute in it, such as compiling a static web page, etc.

### Local `repositories` settings

```shell
$ cd ${sourcesapce}
$ mkdir ${script-name}.sh
```

Add the compiled script in it, such as

```shell
# jekyll
bundle install 
jekyll build

# hexo
npm install
npm build
```

Then `git commit` commit code. Start adding remote repositories

```shell
$ git remote add ${hooks} ${user}@${youripaddr}:${workspace}/${hooks-name}.git 
```

After adding the `push` code

```shell
$ git push ${hooks} master
```

After `hooks` on the server receives the `push` code, it will be synchronized to ${sourcespace}/${hooks-name}, and at the same time execute `${script-name}.sh`. Completion of automatic compilation

### nginx deployment

In the `nginx` configuration file, point the directory to the `_site` generated by the compilation

```shell
location / {
                        root ${sourcespace}/${hooks-name}/site;
                        index index.html index.htm;
                }

```

The entire automated deployment process is over, and every subsequent push code in the local area will trigger automated deployment

## Multiplayer collaboration


In general, a complex project may be completed by multiple people, and each person is only responsible for part of it. It is also worth updating a part. Each person's execution script may be different, so everyone can generate their own githooks warehouse on the server. Then, under `${sourcespace}`, git clone` multiple `hooks` repositories to achieve automatic deployment of multi-person collaboration

However, to avoid code confusion, it is recommended to use the same `hooks`, so that the source code will not be unable to commit.

## **note**

1. `${}` needs to be replaced
